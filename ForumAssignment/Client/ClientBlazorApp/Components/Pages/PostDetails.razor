@page "/post/{Id:int}"
@using ClientBlazorApp.Services.ServiceInterfaces
@rendermode InteractiveServer
@using DTOs.PostDTOs
@using DTOs.CommentDTOs

@inject IPostService PostService
@inject ICommentService CommentService

<h1>Post and Comment Details</h1>

@if (_post is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="card p-3 mb-3">
        <h4>@_post.Title</h4>
        <p>@_post.Body</p>
        <p><i>Author: User @_post.UserId</i></p>
    </div>

    <h5>Comments</h5>

    @if (_comments.Any())
    {
        <ul class="list-group mb-3">
            @foreach (var c in _comments)
            {
                <li class="list-group-item">
                    <div><b>User @c.UserId</b></div>
                    <div>@c.Body</div>
                </li>
            }
        </ul>
    }
    else
    {
        <p>No comments yet.</p>
    }

    <h5>Add Comment</h5>
    <textarea class="form-control mb-2" rows="3" @bind="_newCommentBody"></textarea>
    <button class="btn btn-primary" @onclick="AddComment">Add Comment</button>

    @if (!string.IsNullOrEmpty(_message))
    {
        <p class="text-success mt-2">@_message</p>
    }
    @if (!string.IsNullOrEmpty(_error))
    {
        <p class="text-danger mt-2">@_error</p>
    }
}

@code {
    [Parameter] public int Id { get; set; }

    private OutputPostDTO? _post;
    private List<OutputCommentDTO> _comments = new();

    private string _newCommentBody = "";
    private string? _message;
    private string? _error;

    protected override async Task OnParametersSetAsync()
    {
        _post = await PostService.GetSinglePostAsync(Id);
        _comments = (await CommentService.GetCommentsByPostIdAsync(Id)).ToList();
    }

    private async Task AddComment()
    {
        try
        {
            var dto = new CreateCommentDTO
            {
                PostId = Id,
                UserId = 1,
                Body = _newCommentBody
            };

            var added = await CommentService.AddCommentAsync(dto);

            _comments.Insert(0, added);
            _newCommentBody = "";
            _message = "Comment added!";
            _error = null;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            _message = null;
        }
    }
}
